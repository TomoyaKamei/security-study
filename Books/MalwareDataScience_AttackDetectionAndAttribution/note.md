# マルウェアデータサイエンス ～サイバー攻撃の検出と分析～

## 第0章 はじめに
### はじめに
- セキュリティ業界はデータサイエンスを取り入れつつある。
    - e.g. アンチウィルス製品、ファイヤーウォールベンダ、SIEMソフトウェアなど

### データサイエンスとは何か
- **データサイエンス**とは、統計学・数学・データ可視化を使ってデータを理解し、予測を行う事が可能なアルゴリズムベースのツールの集まりの事である。
- また、データサイエンスは**機械学習**・**データマイニング**・**データ可視化**の三つの要素で構成される。

### データサイエンスは何故セキュリティに取って重要か
- データサイエンスとセキュリティの親和性が高い理由は、3つ存在する。
    1. セキュリティにおいてはデータが全てである。
        - e.g. ファイル、ログ、ネットワークパケット
    2. インターネット上でのサイバー攻撃の数が劇的に増加しており、従来の検知方法では効率が悪くなりつつある。
    3. データサイエンスがセキュリティ業界の内外において技術的なトレンドになっている。

### マルウェアへのデータサイエンスの応用
- **マルウェア**は、悪意を持って書かれた実行プログラムと定義される。
- 本書では、セキュリティデータサイエンスの特定の応用に的を絞る事で、主要なセキュリティ問題にデータサイエンスをどのように応用すれば良いのかを説明したい。


## 第1章 マルウェア
### 概要
- 本章では静的解析の基礎に取り組む。
- 静的解析とは、プログラムを実行せずにプログラムの内容を理解しようとする試みの事である。

### Microsoft WindowsのPEフォーマット
- Windows PE(Portable Executable)は、以下の目的で設計された。
    1. プログラムをメモリに読み込む方法をWindowsに教える。
    2. プログラムが実行中に使用する可能性があるメディア(またはリソース)を提供する。
    3. デジタルコード署名といったセキュリティデータを提供する。

- PEファイルのファイル構造は以下の通りである。
    - **PEヘッダ**
        - プログラムの一般的な属性を定義する。
            - e.g. バイナリコード、画像、圧縮データ...
    - **オプションヘッダ**
        - PEファイル内のプログラムのエントリポイントの場所を定義する。
        - エントリポイントは、プログラムがロードされた後に最初に実行する命令を指す。
        - その他にPEファイルのロード時にWindowsがメモリに読み込むデータのサイズ、Windowsサブシステム、プログラムターゲットなどの詳細定義も行う。
    - **セクションヘッダ**
        - セクションとは、OSがプログラムをロードする時にメモリにマッピングされるデータブロックの事である。
        - セクションヘッダが、そのセクションが読み取り・書き込み・実行を可能にすべきかが明らかになる。
    - **.textセクション**
        - 多くの場合、textセクションがプログラムコードが記載されたセクションとなる。
    - **.idataセクション**
        - DLLのインポートアドレステーブルが含まれている。
    - **データセクション**
        - .rsrc、.data、.rdataセクションが含まれている。
        - これらのセクションには、マウスカーソル画像・ボタンスキン・オーディオなどプログラムによって使用されるその他のメディアが格納される。
    - **.relocセクション**
        - PEバイナリのコードは、メモリないの意図された位置から新しい位置へ移動された場合は正しく実行されなくなる。
        - メモリアドレスのオフセットを増減させる事で、コードを移動しても問題なく実行させるようにOS側に実行させる。

### pefileを使ってPEフォーマットを分析する
- Pythonのpefileライブラリは、PEファイルを調査するための業界標準のマルウェア解析ライブラリである。
```python
import pefile
pe = pefile.PE("ircbot.exe")

for section in pe.sections:
    # セクション名    仮想アドレス    セクションのメモリ数    メモリブロックの消費量    
    print(section.Name, hex(section.VirtualAddress), hex(section.Misc_VirtualSize), section.SizeOfRawData)

# IATをダンプする方法
for entry in pe.DIRECTORY_ENTRY_IMPORT:
    print(entry.dll)
    for function in entry.imports:
        print(f"\t {function.name}")
```

### マルウェアの画像を調べる
- マルウェアが含む画像を調べる事で、マルウェアのバイナリが何に見せかけようとしているかが分かる事がある。
```shell
mkdir images
wrestool -x fakepdfmalware.exe -o images
mkdir putput
icotool -x -o output images/*
eog images/fakepdfmakware.exe_14_101_2052_ico
```

### マルウェアの文字列を調べる
- 文字列は、プログラムバイナリに含まれている一連の印字可能文字の事である。
- マルウェアアナリストは、悪意を持つサンプルに含まれている文字列から内部で何が行われているのかを把握する事がある。
```shell
strings <ファイルパス> | less
```


## 第2章 静的解析の応用: x86逆アセンブリ


### 2.1 逆アセンブリの手法
- 逆アセンブリは、マルウェアのバイナリコードを有効なx86アセンブリ言語に変換するプロセスの事を指す。
- 線形逆アセンブリは、x86プログラムコードに対応するPEファイルで連続する美とシーケンスを特定し、それらのバイトをデコードする行為を指す。
    - 線形逆アセンブリの制約は、難読化やCPUによるデコードを無視する形になってしまう事である。

### 2.2 x86アセンブリ言語の基礎
- アセンブリ言語は、人が読むことが出来るプログラミングコードとしては最も低レベルな言語であり、バイナリ命令フォーマットに対応している。
- マルウェアのアセンブリ言語を用いた解読で、最も重要なのはDLL(Dynamic-Link Library)の解読である。
- CPUレジスタは、x86 CPUが計算を実行するために使用するデータ記憶装置である。
    - 汎用レジスタ
        - アセンブリプログラマが自由に使用できるメモリ空間
    - スタックレジスタ
        - ESP
            - 現在実行中の関数に対するスタックの先頭を指している。
        - EBP
            - 現在実行中の関数に対するスタックの末尾を表している。
    - ESI
        - 現在実行している命令のメモリアドレスが含まれている。
        - mov esp, [esp+8] などの命令があった時に、スタックにバッファオーバーフロー攻撃で移動先を奪える。
- 命令
    - add
        - 
    - sub 
    - inc
    - dec
    - mov
    - push
    - pop 
    - call 
    - ret
    - cmp
    - j*


### 2.3 pefileとcapstoneを使用してircbot.exeを逆アセンブルする

### 2.4 静的解析の制限因子
- パッキング
    - 悪意を持つプログラムの大部分をマルウェアの作成が変換し、マルウェアアナリストが解読出来ないようにするプロセスである。
    - 解読出来ないようにするプロセスは、圧縮・暗号化・マングリングなどが使用される。
- リソースの難読化
    - 検知や解析を回避するためにマルウェアの作成者が使用する手法である。
    - リソースの難読化の方法は様々である。
- アンチ逆アセンブリ
    - 逆アセンブリに内在する手法の制限を利用して解析を防ぐ手段である。
- 動的にダウンロードされるデータ
    - 外部リソースからコード・データ・秘密鍵を入手し、それを実行環境で実行する。
    
### まとめ


## 第3章 速習: 動的解析

### 3.0 概要
- 動的解析の目的はマルウェアの振る舞いを確認する事にある。
- また、動的解析を利用すればパッキングや難読化といった静的解析のハードルも回避する事が出来る。

### 3.1 動的解析を使用するのはなぜか
- パッキングは、マルウェアのx86アセンブリコードを圧縮・難読化して動作の悪意を隠す事にある。
- そのため、マルウェアファイルのどこが難読化されているのか、またコードの難読化を解除して実行できるようにする
　難読化解除サブルーチンの場所を見つけ出す必要がある。
- しかし、サンドボックス環境で実行する事で上記の難読化・パッキングは解除する事が出来る。

### 3.2 マルウェアデータサイエンスのための動的解析
- 動的解析により、マルウェアが何をするのかが明らかになるため、他のマルウェアと関係性を結び付ける事が可能である。
- これによって、マルウェア検出器を学習させる事が可能になる。

### 3.3 動的解析の基本ツール
- インターネット上の動的解析ツールとしては、malwr.coとCuckooBoxが存在する。
- malwr.comは、バイナリを送信すると動的解析を無償で行う事が出来るWebインターフェースが存在する

- **マルウェアの一般的な振る舞い**
    - ファイルシステムの書き換え
        - システム構成ファイルを変更するなど
    - Windowsレジストリを変更してシステム構成を変更
        - ファイアウォールの設定を変更するなど
    - デバイスドライバの読み込み
        - ユーザーのキー入力を記録するデバイスドライバを読み込みなど
    - ネットワークアクション
        - ドメイン名を解決し、HTTPリクエストを送信するなど

- **malwr.comにファイルをロードする**
- **Signaturesパネル**
    - サンプル自体から抽出された概要情報と動的解析環境での実行時の振る舞いに関する情報が含まれている。
- **Screenshotsパネル**
    - マルウェアの実行時に動的解析環境で捉えたデスクトップのスクリーンショットが示される。
- **Modified System Objectsパネル**
    - マルウェアサンプルのネットワークアクティビティやマルウェアが書き換えたシステムオブジェクトが表示される。
- **API呼び出しの解析**
    - マルウェアバイナリの振る舞いに関する詳細情報が表示される。
    - マルウェアによって開始された各プロセスによるAPI呼び出しがそれらの呼び出しに対する引数や戻り値と一緒に表示される。

### 3.4 基本的な動的解析の制限
- 動的解析の重大な制限として、マルウェア作成者が動的解析フレーム解析の事を知っておりそれらを回避する事も可能である。
- また、動的解析が回避されないまでも、マルウェアの重要な動作を回避させる事も可能である。



## 第4章 マルウェアネットワークを使った攻撃キャンペーンの特定

### 4.0 まとめ
- マルウェアネットワーク解析は、マルウェアサンプルの各グループの繋がりを共通の属性に基づいて解析する。

### 4.1 ノードとエッジ
- ネットワークとは、接続されたオブジェクトの集まりであり、それらのオブジェクトはノードと呼ばれ、ノード間の接続はエッジと呼ばれる。
- 似たようなマルウェアファイルは、エッジを共有しクラスタを形成する。
- なおエッジに重みを付ける事で、関係性を定義する事が出来る。

### 4.2 2部ネットワーク
- 2部ネットワークはノードの集合を2つのパーティションに分割した時に、どちらのパーティション内でもノード同士が繋がらないネットワークの事である。
- 

### 4.3 マルウェアネットワークを可視化する

### 4.4 NetworkXを使ってネットワークを構築する

### 4.5 ノードとエッジを追加する

### 4.6 GraphVizを使ってネットワークを可視化する

### 4.7 マルウェアネットワークを構築する

### 4.8 共有画像ネットワークを構築する

### 4.9 まとめ


## 調査

### CuckooBoxについて調査する。

## 参照
