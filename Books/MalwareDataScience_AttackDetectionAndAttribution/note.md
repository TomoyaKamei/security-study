# マルウェアデータサイエンス ～サイバー攻撃の検出と分析～

## 第0章 はじめに
### はじめに
- セキュリティ業界はデータサイエンスを取り入れつつある。
    - e.g. アンチウィルス製品、ファイヤーウォールベンダ、SIEMソフトウェアなど

### データサイエンスとは何か
- **データサイエンス**とは、統計学・数学・データ可視化を使ってデータを理解し、予測を行う事が可能なアルゴリズムベースのツールの集まりの事である。
- また、データサイエンスは**機械学習**・**データマイニング**・**データ可視化**の三つの要素で構成される。

### データサイエンスは何故セキュリティに取って重要か
- データサイエンスとセキュリティの親和性が高い理由は、3つ存在する。
    1. セキュリティにおいてはデータが全てである。
        - e.g. ファイル、ログ、ネットワークパケット
    2. インターネット上でのサイバー攻撃の数が劇的に増加しており、従来の検知方法では効率が悪くなりつつある。
    3. データサイエンスがセキュリティ業界の内外において技術的なトレンドになっている。

### マルウェアへのデータサイエンスの応用
- **マルウェア**は、悪意を持って書かれた実行プログラムと定義される。
- 本書では、セキュリティデータサイエンスの特定の応用に的を絞る事で、主要なセキュリティ問題にデータサイエンスをどのように応用すれば良いのかを説明したい。


## 第1章 マルウェア
### 概要
- 本章では静的解析の基礎に取り組む。
- 静的解析とは、プログラムを実行せずにプログラムの内容を理解しようとする試みの事である。

### Microsoft WindowsのPEフォーマット
- Windows PE(Portable Executable)は、以下の目的で設計された。
    1. プログラムをメモリに読み込む方法をWindowsに教える。
    2. プログラムが実行中に使用する可能性があるメディア(またはリソース)を提供する。
    3. デジタルコード署名といったセキュリティデータを提供する。

- PEファイルのファイル構造は以下の通りである。
    - **PEヘッダ**
        - プログラムの一般的な属性を定義する。
            - e.g. バイナリコード、画像、圧縮データ...
    - **オプションヘッダ**
        - PEファイル内のプログラムのエントリポイントの場所を定義する。
        - エントリポイントは、プログラムがロードされた後に最初に実行する命令を指す。
        - その他にPEファイルのロード時にWindowsがメモリに読み込むデータのサイズ、Windowsサブシステム、プログラムターゲットなどの詳細定義も行う。
    - **セクションヘッダ**
        - セクションとは、OSがプログラムをロードする時にメモリにマッピングされるデータブロックの事である。
        - セクションヘッダが、そのセクションが読み取り・書き込み・実行を可能にすべきかが明らかになる。
    - **.textセクション**
        - 多くの場合、textセクションがプログラムコードが記載されたセクションとなる。
    - **.idataセクション**
        - DLLのインポートアドレステーブルが含まれている。
    - **データセクション**
        - .rsrc、.data、.rdataセクションが含まれている。
        - これらのセクションには、マウスカーソル画像・ボタンスキン・オーディオなどプログラムによって使用されるその他のメディアが格納される。
    - **.relocセクション**
        - PEバイナリのコードは、メモリないの意図された位置から新しい位置へ移動された場合は正しく実行されなくなる。
        - メモリアドレスのオフセットを増減させる事で、コードを移動しても問題なく実行させるようにOS側に実行させる。

### pefileを使ってPEフォーマットを分析する
- Pythonのpefileライブラリは、PEファイルを調査するための業界標準のマルウェア解析ライブラリである。
```python
import pefile
pe = pefile.PE("ircbot.exe")

for section in pe.sections:
    # セクション名    仮想アドレス    セクションのメモリ数    メモリブロックの消費量    
    print(section.Name, hex(section.VirtualAddress), hex(section.Misc_VirtualSize), section.SizeOfRawData)

# IATをダンプする方法
for entry in pe.DIRECTORY_ENTRY_IMPORT:
    print(entry.dll)
    for function in entry.imports:
        print(f"\t {function.name}")
```

### マルウェアの画像を調べる
- マルウェアが含む画像を調べる事で、マルウェアのバイナリが何に見せかけようとしているかが分かる事がある。
```shell
mkdir images
wrestool -x fakepdfmalware.exe -o images
mkdir putput
icotool -x -o output images/*
eog images/fakepdfmakware.exe_14_101_2052_ico
```

### マルウェアの文字列を調べる
- 文字列は、プログラムバイナリに含まれている一連の印字可能文字の事である。
- マルウェアアナリストは、悪意を持つサンプルに含まれている文字列から内部で何が行われているのかを把握する事がある。
```shell
strings <ファイルパス> | less
```


## 静的解析の応用: x86逆アセンブリ


### 逆アセンブリの手法
- 逆アセンブリは、マルウェアのバイナリコードを有効なx86アセンブリ言語に変換するプロセスの事を指す。
- 線形逆アセンブリは、x86プログラムコードに対応するPEファイルで連続する美とシーケンスを特定し、それらのバイトをデコードする行為を指す。
    - 線形逆アセンブリの制約は、難読化やCPUによるデコードを無視する形になってしまう事である。

### x86アセンブリ言語の基礎
- アセンブリ言語は、人が読むことが出来るプログラミングコードとしては最も低レベルな言語であり、バイナリ命令フォーマットに対応している。
- マルウェアのアセンブリ言語を用いた解読で、最も重要なのはDLL(Dynamic-Link Library)の解読である。
- CPUレジスタは、x86 CPUが計算を実行するために使用するデータ記憶装置である。
    - 汎用レジスタ
        - アセンブリプログラマが自由に使用できるメモリ空間
    - スタックレジスタ
        - ESP
            - 現在実行中の関数に対するスタックの先頭を指している。
        - EBP
            - 現在実行中の関数に対するスタックの末尾を表している。
    - ESI
        - 現在実行している命令のメモリアドレスが含まれている。
        - mov esp, [esp+8] などの命令があった時に、スタックにバッファオーバーフロー攻撃で移動先を奪える。
- 命令
    - add
        - 
    - sub 
    - inc
    - dec
    - mov
    - push
    - pop 
    - call 
    - ret
    - cmp
    - j*


### pefileとcapstoneを使用してircbot.exeを逆アセンブルする

### 静的解析の制限因子
- パッキング
    - 悪意を持つプログラムの大部分をマルウェアの作成が変換し、マルウェアアナリストが解読出来ないようにするプロセスである。
    - 解読出来ないようにするプロセスは、圧縮・暗号化・マングリングなどが使用される。
- リソースの難読化
    - 検知や解析を回避するためにマルウェアの作成者が使用する手法である。
    - リソースの難読化の方法は様々である。
- アンチ逆アセンブリ
    - 逆アセンブリに内在する手法の制限を利用して解析を防ぐ手段である。
- 動的にダウンロードされるデータ
    - 外部リソースからコード・データ・秘密鍵を入手し、それを実行環境で実行する。
    

### まとめ
## 調査
## 参照
